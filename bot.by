import os
import asyncio
from telegram import Update
from telegram.ext import Application, MessageHandler, filters, ContextTypes
import yt_dlp

# Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡
TOKEN = '7948066297:AAFWxNQ7hZjOLhMVtGwoR-xQ4sZfNqWn_wI'

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø±Ùƒ (Grably Engine)
def download_video(url):
    ydl_opts = {
        'format': 'best[ext=mp4]/best', # Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø© Ø¨ØµÙŠØºØ© mp4
        'outtmpl': 'video_%(id)s.%(ext)s', # ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù Ø¨Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙÙŠ ÙØ±ÙŠØ¯
        'max_filesize': 45 * 1024 * 1024,  # Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… (45 Ù…ÙŠØ¬Ø§)
        'quiet': True,
    }
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        info = ydl.extract_info(url, download=True)
        return ydl.prepare_filename(info)

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
async def handle_video_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = update.message.text
    
    if "http" not in url:
        await update.message.reply_text("Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø±Ø§Ø¨Ø·Ø§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹ ÙŠØ§ Ø¹Ù„ÙŠ ğŸ”—")
        return

    msg = await update.message.reply_text("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ³Ø­Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ... Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø© â³")
    
    try:
        # ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ù…Ø³Ø§Ø± Ù…Ù†ÙØµÙ„ Ù„Ø¹Ø¯Ù… ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø¨ÙˆØª
        file_path = await asyncio.to_thread(download_video, url)
        
        await update.message.reply_video(
            video=open(file_path, 'rb'),
            caption="ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙˆØª Ù†ÙˆØ± ğŸ¥"
        )
        
        # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        os.remove(file_path)
        await msg.delete()
        
    except Exception as e:
        await msg.edit_text(f"Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: {str(e)}")
        if 'file_path' in locals() and os.path.exists(file_path):
            os.remove(file_path)

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
if __name__ == '__main__':
    print("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ÙŠØ§ Ø¹Ù„ÙŠ... Ø¬Ø±Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ!")
    app = Application.builder().token(TOKEN).build()
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_video_request))
    app.run_polling()
